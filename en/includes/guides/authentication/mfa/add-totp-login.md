# Add MFA with TOTP

The Time-based One-Time Password (TOTP) is a temporary passcode, generated by an algorithm that can be used only once. The algorithm that generates each password uses the current time of the day, which ensures that each password is unique.
TOTP is considered more secure because the passcode is valid only for a short window of time. The TOTP generated by {{ product_name }} is valid for **30** seconds.

To use TOTP as a multi-factor authentication(MFA) option, application users need to have an authenticator app that can scan the QR code and generate a one-time password. Some authenticator apps are:

- [Google Authenticator](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2){:target="_blank"}
- [Authy](https://play.google.com/store/apps/details?id=com.authy.authy){:target="_blank"}

!!! note
    TOTP authenticators use the [TOTP specification](https://datatracker.ietf.org/doc/html/rfc6238){:target="_blank"} to calculate access tokens based on the current time and the secret key shared between the user and the identity provider.

## Prerequisites
- To get started, you need to [register an application with {{ product_name }}]({{base_path}}/guides/applications/). You can register your own application or use one of the [sample applications]({{base_path}}/get-started/try-samples/) provided.

- Download and install one of the authenticator apps mentioned above.

!!! note
    - You can use TOTP for multi-factor authentication only if a previous authentication step is configured with **username and password** or another factor that can validate user credentials.
    - TOTP cannot be used as the first step of your login flow.
    - Federated users (users who are authenticated using external IdPs) can log in with TOTP MFA option.

## Enable TOTP for an app

{% include "../../../guides/fragments/add-login/mfa/add-totp-login.md" %}

## Disable enrolling in TOTP during first login

TOTP enrollment during the first login is enabled by default for all applications.

{{ product_name }} provides two ways to control this enrollment behavior:

- **Organization-level configuration**: Define a default policy that applies across all applications in the organization.
- **Application-level configuration**: Override the organization-level setting for specific applications using conditional authentication scripts.

!!! note
    Use the organization-level configuration for both root organizations and sub-organizations.

### Configure at organization level

To configure TOTP enrollment for all applications in your organization:

1. On the {{ product_name }} Console, go to **Connections**.

2. Click on **TOTP** and go to the **Settings** tab.

3. Use the **Enable TOTP progressive enrollment** toggle to control the enrollment behavior:

    - **Enabled (default)**: Prompt users who haven't configured TOTP to enroll during login for all applications, unless it's overridden by **Conditional Authentication**.
    - **Disabled**: Users aren't prompted to enroll in TOTP during login for any application in the organization.

    ![TOTP organization level configuration in {{ product_name }}]({{base_path}}/assets/img/guides/mfa/totp/totp-org-level-config.png){: style="display: block; margin: 0; border: 0.3px solid lightgrey;"}

4. Click **Update** to save your changes.

### Configure at application level

To override the organization-level setting for a specific application:

1. On the {{ product_name }} Console, [enable TOTP](#enable-totp-for-an-app)  for a selected application.
2. Turn on **Conditional Authentication** by switching the toggle.
3. Add the following authentication script.

    !!! note
        The `authenticatorParams` method has been added to `executestep(2)`, assuming that TOTP is configured in step 2 of the authentication process. If you have configured TOTP in a different step, add the `authenticatorParams` method to the relevant step.

    ``` js
    var enrolUserInAuthenticationFlow = "false";

    var onLoginRequest = function (context) {
      executeStep(1);
      executeStep(2, {
          authenticatorParams: {
            common: {
                'enrolUserInAuthenticationFlow': enrolUserInAuthenticationFlow
            }
          }
      }, {
          onSuccess: function (context) {
            Log.info("Successfully managed login flow");
          }
      });
    };
    ```

    !!! note "Enable enrolling in TOTP at first login"
        To enable enrolling in TOTP the first time a user logs in, use any of the following approaches:
          
          - Update the value of `enrolUserInAuthenticationFlow` parameter to `true`.
            ```js 
            var enrolUserInAuthenticationFlow = "true";
            ```
          - Turn off **Conditional Authentication** by switching the toggle.

4. Click **Update** to save your changes.

## Try it out

Application users can enroll for TOTP authentication when they login to the business application for the first time. Given below are the steps that a user will follow:

1. Download an authenticator app to a mobile device.
2. Try to log in to the application by providing credentials. The user is prompted with a QR code.
3. Scan the QR code using the authenticator app, select the checkbox, and click **Continue**.

    !!! note
        - This step is prompted only when the user attempts to log in for the first time.
        - This step will not be prompted if you have [disabled enrolling in TOTP during first login](#disable-enrolling-in-totp-during-first-login).

    ![QR code for TOTP authenticator in {{ product_name }}]({{base_path}}/assets/img/guides/mfa/totp/scan-qr-code-totp.png){: width="300" style="border: 0.3px solid lightgrey;"}

4. Check the authenticator app and see that the TOTP is generated.

5. Enter the TOTP:
  
    ![User enters OTP token in {{ product_name }}]({{base_path}}/assets/img/guides/mfa/totp/enter-otp-token.png){: width="300" style="border: 0.3px solid lightgrey;"}

6. Click **Continue** to continue login.

!!! note
    If the QR code is deleted from the authenticator app, there is no way to recover it from the application. In such a scenario, the user should re-enroll for TOTP through the <b>Multi Factor Authentication</b> option in the My Account portal.

    Learn more about [enrolling TOTP from My Account]({{base_path}}/guides/user-self-service/enable-totp/).
